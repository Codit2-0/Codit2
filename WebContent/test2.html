<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <meta charset="ISO-8859-1">
  <title>Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- a differenza del default di questo
       template, abbiamo deciso di far scomparire
       completamente la barra laterale
  -->
  <style>
    @media (min-width: 992px) {
      .sidebar-mini.sidebar-collapse .main-sidebar {
        width: 0;
      }
      .sidebar-mini.sidebar-collapse .main-header,
      .sidebar-mini.sidebar-collapse .content-wrapper {
        margin-left: 0 !important;
      }
    }
  </style>
</head>
<style>

.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}

path{
	stroke: #999;
}
path.selected {
	stroke: #FF0000;
}

text {
  font-family: sans-serif;
  font-size: 12px;
}

</style>
<body>
 <div class="card-body">
   <form method="post" enctype="multipart/form-data" role="form">
     <div class="form-group">
       <label for="path">Selezionare file .xmi</label>
       <div class="input-group">
         <div class="custom-file">
         	 <input type="file" id="path" name="file" class="custom-file-input">
           <label class="custom-file-label" for="path">Choose file</label>
         </div>
         <div class="input-group-append">
           <span class="btn btn-default" style="background-color: #e9ecef;" onclick="writeDatabase()">
             Upload
           </span>
         </div>
       </div>
     </div>
   </form>
 </div>
</body>
<svg width="900" height="1200" style="display: none;"></svg>
<script src="plugins/jquery/jquery.min.js"></script>
<script src="plugins/jquery-ui/jquery-ui.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="plugins/bs-custom-file-input/bs-custom-file-input.min.js"></script>
<script type="text/javascript">
  $(document).ready(function () {
    bsCustomFileInput.init();
  });
</script>
<script type="text/javascript">


var data = [];
var links = [];
var nodes = [];
var svg = d3.select("svg"),width = 900, height = 600;

function writeDatabase() {
	
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {loadSchemaER(this);}
	};
	
	var formData = new FormData();
	formData.append("file", document.getElementById("path").files[0]);

	xmlhttp.open("POST", "JSONSchemaER", true);
	xmlhttp.send(formData);
}
//Continuare a implementare la funzione su onclick
		
function loadSchemaER(xmlhttp) {
	data = JSON.parse(xmlhttp.responseText);
	
	var i = 0;
	while(data.entity[i] != null){
		var j = 0;
		nodes.push({id:data.entity[i].name, type: "symbolSquare", color: "lightgreen"});
		while(data.entity[i].attributes[j] != null){
			var w = 0, control = true;
			while(nodes[w] != null){
				if(data.entity[i].attributes[j] == nodes[w].id) control = false;
				w++;
			}
			if(control == true) {
				nodes.push({id:data.entity[i].attributes[j], type: "symbolCircle", color: "lightblue"});
				links.push({source: data.entity[i].attributes[j], target: data.entity[i].name , value: 4});	
			}
			else {
				nodes.push({id: data.entity[i].name + "-" + data.entity[i].attributes[j], type: "symbolCircle", color: "lightblue"});
				links.push({source: data.entity[i].name + "-" + data.entity[i].attributes[j], target: data.entity[i].name , value: 4});	
			}
			
			j++;
		}
		i++;
	}
		
	
	i = 0;
	while(data.association[i] != null){
		links.push({source: data.association[i].entity1, target: data.association[i].name , value: 1});	
		links.push({source: data.association[i].entity2, target: data.association[i].name , value: 1});	
		nodes.push({id:data.association[i].name, type:"symbolDiamond", color: "pink"});
		i++;
	}
	
	var simulation = d3.forceSimulation()
    					.force("link", d3.forceLink().distance(200).id(function(d) { return d.id; }))
    					.force("charge", d3.forceManyBody())
    					.force("center", d3.forceCenter(width / 2, height));


	var link = svg.append("g")
  					.attr("class", "links")
	 				.selectAll("line")
					.data(links)
					.enter().append("line")
  					.attr("stroke-width", function(d) { return Math.sqrt(d.value); });
	

	var node = svg.append("g")
					.attr("class", "nodes")
					.attr("opacity",1)
					.selectAll("g")
					.data(nodes)
					.enter().append("g")
					.on("click", function(){
						
						//Funzione per la selezione e la deselezione di entità e relazioni
						
						if(d3.select(this)._groups[0][0].__data__.type == "symbolSquare"){
							var numAttributi = 0;
							var indexEntity = d3.select(this)._groups[0][0].__data__.index;
							var j = indexEntity;
							var nomeEntity = d3.select(this)._groups[0][0].__data__.id;
							var length = d3.selectAll(link)._groups[0]._groups[0].length;
								while(true){
									j++;
									if(d3.selectAll(node)._groups[0]._groups[0][j].__data__.type == "symbolCircle"){
										numAttributi++;
									} else {
										break;
									}
								}
								for(var i = indexEntity + 1; i<=numAttributi+indexEntity ;i++){

									if(d3.select(this)._groups[0][0].childNodes[0].style.stroke == "red"){
										d3.selectAll(node)._groups[0]._groups[0][i].childNodes[0].style.stroke = "#999";
										d3.selectAll(node)._groups[0]._groups[0][i].childNodes[0].style.strokeWidth = 1;
									} else {	
										d3.selectAll(node)._groups[0]._groups[0][i].childNodes[0].style.stroke = "red";
										d3.selectAll(node)._groups[0]._groups[0][i].childNodes[0].style.strokeWidth = 4;
									}
								}
								if(d3.select(this)._groups[0][0].childNodes[0].style.stroke == "red"){
							
									d3.select(this)._groups[0][0].childNodes[0].style.stroke = "#999";
									d3.select(this)._groups[0][0].childNodes[0].style.strokeWidth = 1;
								} else {
									d3.select(this)._groups[0][0].childNodes[0].style.stroke = "red";
									d3.select(this)._groups[0][0].childNodes[0].style.strokeWidth = 4;
								}
						} else if(d3.select(this)._groups[0][0].__data__.type == "symbolDiamond"){
							if(d3.select(this)._groups[0][0].childNodes[0].style.stroke == "red"){
								
								d3.select(this)._groups[0][0].childNodes[0].style.stroke = "#999";
								d3.select(this)._groups[0][0].childNodes[0].style.strokeWidth = 1;
							} else {
								d3.select(this)._groups[0][0].childNodes[0].style.stroke = "red";
								d3.select(this)._groups[0][0].childNodes[0].style.strokeWidth = 4;
							}
						}
					})
					.on("dblclick", function(){
						
					// Funzione per far scomparire e ricomparire gli attributi di una entità al doubleclick
						if(d3.select(this)._groups[0][0].__data__.type == "symbolSquare"){
						var numAttributi = 0;
						var indexEntity = d3.select(this)._groups[0][0].__data__.index;
						var j = indexEntity;
						var nomeEntity = d3.select(this)._groups[0][0].__data__.id;
						var length = d3.selectAll(link)._groups[0]._groups[0].length;
							while(true){
								j++;
								if(d3.selectAll(node)._groups[0]._groups[0][j].__data__.type == "symbolCircle"){
									numAttributi++;
								} else {

									break;
								}
							}
						for(var i = indexEntity + 1; i<=numAttributi+indexEntity ;i++){
							if(d3.selectAll(node)._groups[0]._groups[0][i].style.opacity == 1||d3.selectAll(node)._groups[0]._groups[0][i].style.opacity == ""){
							d3.selectAll(node)._groups[0]._groups[0][i].style.opacity = 0;
							}else{
								d3.selectAll(node)._groups[0]._groups[0][i].style.opacity = 1;
							}
							
						}
						for(var j = 0; j<length; j++){
							if(d3.selectAll(link)._groups[0]._groups[0][j].__data__.target.id == nomeEntity){
								if(d3.selectAll(link)._groups[0]._groups[0][j].style.opacity == 1 || d3.selectAll(link)._groups[0]._groups[0][j].style.opacity == ""){
								d3.selectAll(link)._groups[0]._groups[0][j].style.opacity = 0;
								}else{
									d3.selectAll(link)._groups[0]._groups[0][j].style.opacity = 1;
								}
							}
						}
						}
					});

	var symbolGenerator = d3.symbol().size(2000);


	var circles = node.append("path")
						.attr("r", 20)
						.attr("fill", function(d){ return d.color })
						.attr('d', function(d) {symbolGenerator.type(d3[d.type]);return symbolGenerator();})
						.call(d3.drag().on("start", dragstarted).on("drag", dragged));
	
	var lables = node.append("text")
  					.text(function(d) {return d.id;})
  					.attr('x', -15)
  					.attr('y', 2);

	node.append("title").text(function(d) { return d.id; });

	simulation.nodes(nodes).on("tick", ticked);

	simulation.force("link").links(links);

	function ticked() {
		link.attr("x1", function(d) { return d.source.x; })
	    	.attr("y1", function(d) { return d.source.y; })
    		.attr("x2", function(d) { return d.target.x; })
    		.attr("y2", function(d) { return d.target.y; });

		node.attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")";})
	}

	function dragstarted(d) {
		if (!d3.event.active) simulation.alphaTarget(0.3).restart();
		d.fx = d.x;
		d.fy = d.y;
	}

	function dragged(d) {
		d.fx = d3.event.x;
		d.fy = d3.event.y;
	}

	//Questa è la funzione per bloccare i nodie va inserita in circles
	function dragended(d) {
  		if (!d3.event.active) simulation.alphaTarget(0);
  		d.fx = null;
  		d.fy = null;
	}
	
	// d3.select(".card-body").style("display", "none");
	d3.select("svg").style("display", "inline");
}


</script>