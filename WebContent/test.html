<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="css/Select.css">
<meta charset="ISO-8859-1">
<title>Insert title here</title>
</head>
<body>
<div id="demo" style="position: absolute; left: 100px; top: 100px;"></div>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.10/d3.min.js"></script>
<script src="multiline-text.js"></script>
<script src="class-diagram.js"></script>
<script type = "text/javascript" src="js/jquery3.js"></script>
<script type="text/javascript">
		
	var svg = d3.select('#demo').append('svg').attr({width: 2000,height: 2000});
	d3.classDiagram.addMarkers(svg.append('defs'));

	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {loadSchemaER(this);}
	};
	xmlhttp.open("GET", "JSONSchemaER", true);
	xmlhttp.send();
			
	function loadSchemaER(xmlhttp) {
		
		var classes = [];
		var connectors = [];
		var sort = [];
		var rel = [];
		var data = JSON.parse(xmlhttp.responseText);
		
		//Creazione array per il sort
		var i = 0, w = 0, v = 0;
		while(data.association[i] != null){		
			var j = 0;
			var contenuto = true;
			while(sort[j] != null){
				if(sort[j].nomeEntita == data.association[i].entity1){
					contenuto = false;
				}
				j++;
			}
			if(contenuto == true) sort.push({nomeEntita: data.association[i].entity1})
			
			j = 0;
			contenuto = true;
			while(sort[j] != null){
				if(sort[j].nomeEntita == data.association[i].entity2){
					contenuto = false;
				}
				j++;
			}
			if(contenuto == true) sort.push({nomeEntita: data.association[i].entity2})

			i++;
		}
		
		//Creazione della struttura che contiene le entita
		i = 0;
		while(data.entity[i] != null){
			classes.push({
				x: 400, y: 400, width: 150,
				classname:data.entity[i].name,
				key: [data.entity[i].attributes[0]],
				attributes: data.entity[i].attributes
			});	
			i++;
		}
		
		//Sort delle entita
		i = 0;
		while(sort[i] != null){
			var j = 0;
			while(classes[j] != null){
				if(sort[i].nomeEntita == classes[j].classname){
					classes[j].x = 400*w;
					classes[j].y = 400*v;
				}
				j++;
			}
			
			w = w + 1;
			if(w%3 == 0){v++; w =  0;}
			i++;
		}
		
		//Creazione della struttura che contiene le associzioni
		i = 0, w = 1, v = 1
		;
		while(data.association[i] != null){
			rel.push({
				x: 200*w, y: 200*v, width: 70,
				classname:data.association[i].name
			});	
			
			w = w + 2;
			if(w%7 == 0){v = v + 2; w =  1;}
			i++;
		}
		
		var boxes2 = d3.classDiagram.createRel(rel);
		var boxes = d3.classDiagram.createClasses(classes);
		svg.selectAll('text').attr('font-family', 'Noto Sans Japanese');
		
		//Creazione delle linee che rappresentano i collegamenti
		i = 0, w = 1, v = 0;
		var posXEntity1, posYEntity1,posXEntity2, posYEntity2, posXRelazione, posYRelazione;
		while(data.association[i] != null){
			
			//Punti X e Y delle associazioni
			var j = 0;
			
			while(rel[j] != null){
				if(data.association[i].name == rel[j].classname){
					posXRelazione = rel[j].x;
					posYRelazione = rel[j].y;
				}
				j++;
			}
			
			
			//Punti X e Y dell' entita 1
			j = 0;
			while(data.entity[j] != null){
				if(data.association[i].entity1 == data.entity[j].name){
					posXEntity1 = classes[j].x;
					if(posXEntity1 == 0){posXEntity1 = posXEntity1 + 150}
					posYEntity1 = classes[j].y;
				}
				j++;
			}
			
			//Aggiunta linea da Entita 1 a associzione
			connectors.push({
				points: [
					{x: posXEntity1, y: posYEntity1 + 60},
				    {x: posXRelazione, y: posYRelazione}
				],
			});
			
			//Punti X e Y dell' entita 2
			j = 0;
			while(data.entity[j] != null){
				if(data.association[i].entity2 == data.entity[j].name){
					posXEntity2 = classes[j].x;
					if(posXEntity2 == 0){posXEntity2 = posXEntity2 + 150}
					posYEntity2 = classes[j].y;
				}
				j++;
			}
			
			
			//Aggiunta linea da Entita 2 a associzione
			connectors.push({
				points: [
					{x: posXRelazione + 100, y: posYRelazione},
				    {x: posXEntity2, y: posYEntity2}
				],
			});
			
			i++;
		}
		
		
	
		d3.classDiagram.createConnectors(connectors);
		
		
		/*
		var listaAttributi="";
		while(data.entity[i] != null){
			while(data.entity[i].attributes[j] != null){
				listaAttributi += "<li>"+data.entity[i].attributes[j];
				j++;
			}
			document.getElementById("demo").innerHTML += "<table style='position: absolute;top: "+(400*y)+"px; left: "+(400*x)+"px;' border='3'><tr><td>"+data.entity[i].name+"</td></tr><tr><td>LISTA ATTRIBUTI<ul>"+listaAttributi+"</ul></td></tr></table>";
			x = x + 1;
			if(x%3 == 0){y++; x =  0;}
			i++;
		}
		*/
		
		/*
		i = 0, j = 0, x = 1, y = 0;
		listaAttributi="";
		while(data.association[i] != null){
			while(data.association[i].attributes[j] != null){
				listaAttributi += "<li>"+data.entity[i].attributes[j];
				j++;
			}
			document.getElementById("demo").innerHTML += "<table style='position: absolute;top: "+(400*y)+"px; left: "+(200*x)+"px;' border='3'><tr><td>"+data.association[i].name+"</td></tr><tr><td>ENTITA LEGATE<ul><li>"+data.association[i].entity1+"<li>"+data.association[i].entity2+"</ul></td></tr><tr><td>LISTA ATTRIBUTI<ul>"+listaAttributi+"</ul></td></tr></table>";
			x = x + 2;
			if(x%7 == 0){y++; x =  1;}
			i++;
		}
		*/		
	}			
</script>
</body>
</html>